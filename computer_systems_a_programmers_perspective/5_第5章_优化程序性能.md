[TOC]

# 第5章 优化程序性能

- 编写高效程序需要几类活动：
  - 必须选择一组合适的算法和数据结构
  - 必须编写出编译器能够有效优化以转换成高效可执行代码的源代码
    - 理解优化编译器的能力和局限性
    - 最好的编译器也会受到妨碍优化的因素的阻碍
  - 将一个任务拆分成多个任务，在多核处理器上并行地计算

- 程序优化的步骤
  1. 消除不必要的内容
      - 不必要的函数调用
      - 不必要的条件测试
      - 不必要的存储器引用
  1. 利用处理器提供的指令级并行能力
      - 降低一个计算不同部分之间的数据相关

- 程序优化的方法和工具
  - 研究程序的汇编代码
  - 确认循环中的关键路径
    - 关键路径是指在循环的反复执行过程中形成的数据相关链
  - 不断修改源代码，欺骗编译器产生有效的代码

## 5.1 优化编译器的能力和局限性

> 编译器必须很小心地对程序只使用==安全==的优化

- 妨碍编译器进行优化的因素
  - 两个指针可能指向同一个位置
    - 示例：
      ```C++
      // 如果 xp 和 yp 指向不同位置，twiddle1 和 twiddle2 等效
      // 否则，twiddle1 中 *xp 的值变为 4 倍；twiddle2 中 *xp 的值变为 3 倍
      void twiddle1(int *xp, int *yp)
      {
          *xp += *yp;
          *xp += *yp;
      }

      void twiddle2(int *xp, int *yp)
      {
          *xp += 2 * *yp;
      }
      ```
  - 函数可能具有副作用
    - 示例：
      ```C++
      int func1()
      {
          return f() + f() + f() + f();
      }

      int func2()
      {
          return 4 * f();
      }

      int counter = 0;
      int f()
      {
          return counter++;
      }
      ```

> 在各种编译器中，就优化能力来说，GCC 被认为是胜任的，但是并不是特别突出。它完成基本的优化，但是它不会对程序进行更加“有进取心”编译器所做的那种激进变换。